<?php
date_default_timezone_set("Asia/kolkata");
//echo date_default_timezone_get();

include('adminFunction.php');
// include('function.php');


switch ($_REQUEST['action']) {
  case 'changeimg':
    if (changeimg($_FILES["profile"]["name"], $_FILES["profile"]["tmp_name"])) {
      echo "<script>alert('Profile photo uploaded successfully');window.location='../profile.php';</script>";
    } else {
      echo "<script>alert('Failed to upload');window.location='../profile.php';</script>";
    }
    break;
  case 'updateUser':
    $fname = $_REQUEST['fname'];
    $email = $_REQUEST['email'];
    $mobile = $_REQUEST['mobile'];
    $design = $_REQUEST['design'];
    if (updateUser($fname, $email, $mobile, $design))
      echo "<script>alert('User details updated successfully');window.location='../profile.php';</script>";
    else
      echo "<script>alert('User details not updated');window.location='../profile.php';</script>";
    break;
  case 'changePass':
    $pass = $_REQUEST['pass'];
    $confirm = $_REQUEST['confirm'];
    if ($pass == $confirm) {
      if (changePass($pass, $confirm))
        echo "<script>alert('User Password changed successfully');window.location='../profile.php';</script>";
      else
        echo "<script>alert('User Password not changed');window.location='../profile.php';</script>";
    } else {
      echo "<script>alert('Confirm password must match with password');window.location='../profile.php';</script>";
    }
    break;
  case 'AddDesign':
    $design = $_REQUEST['design'];
    if (AddDesign($design))
      echo "<script>alert('Designation Added successfully');window.location='../Designation.php';</script>";
    else
      echo "<script>alert('Something went wrong');window.location='../Designation.php';</script>";
    break;
  case 'fetchDesign':
    $id = $_REQUEST['id'];
    echo fetchDesign($id);
    break;

  case 'already':
    //$data=0;
    $id = $_POST['id'];
    $sql = mysqli_query($conn, "Select empid from users where empid='" . $id . "'");
    //echo "Select empid from users where empid='".$id."'";
    echo mysqli_num_rows($sql);

    break;

  case 'UpdateDesign':
    $update_design = $_REQUEST['update_design'];
    $update_id = $_REQUEST['update_id'];
    if (UpdateDesign($update_design, $update_id))
      echo "<script>alert('Designation Updated successfully');window.location='../Designation.php';</script>";
    else
      echo "<script>alert('Something went wrong');window.location='../Designation.php';</script>";
    break;
  case 'DeleteDesign':
    $delete_id = $_REQUEST['delete_id'];
    if (DeleteDesign($delete_id))
      echo "<script>alert('Designation Deleted successfully');window.location='../Designation.php';</script>";
    else
      echo "<script>alert('Something went wrong');window.location='../Designation.php';</script>";
    break;

  case 'addEmployee':
    $empid = $_REQUEST['empid'];
    $gradepay = $_REQUEST['gradepay'];
    $fullname = $_REQUEST['fullname'];
    $dept = $_REQUEST['dept'];
    $billunit = $_REQUEST['billunit'];
    $design = $_REQUEST['design'];
    $mobile = $_REQUEST['mobile'];
    $station = $_REQUEST['station'];
    $email = $_REQUEST['email'];
    $address = $_REQUEST['address'];
    if (addEmployee($empid, $gradepay, $fullname, $dept, $billunit, $design, $mobile, $station, $email, $address))
      echo "<script>alert('Employee Added successfully');window.location='../user_registration.php';</script>";
    else
      echo "<script>alert('Failed to add employee');window.location='../user_registration.php';</script>";
    break;
  case 'FetchEmployee':
    $id = $_REQUEST['id'];
    echo FetchEmployee($id);
    break;
  case 'fetchEmployee1':
    $id = $_REQUEST['id'];
    echo fetchEmployee1($id);
    break;
  case 'deleteEmployee':
    $delete_id = $_REQUEST['id'];
    if (deleteEmployee($delete_id))
      echo "Employee Details Deleted successfully";
    else
      echo "Failed to delete employee";
    break;
  case 'claimTA':
    $cnt = $_REQUEST['hide_count'];
    $empid = $_REQUEST['empid'];
    $year = $_REQUEST['year'];
    $set = $_REQUEST['set'];
    $months = implode(",", $_REQUEST['month']);
    $ref = rand(10000, 999999);
    $reference = $empid . "/" . $year . "/" . $ref;
    $data = [];
    for ($i = 0; $i <= $cnt; $i++) {
      $data['date'][$i] =  $_REQUEST["date$i"];
      $data['train'][$i] =  $_REQUEST["train$i"];
      $data['departS'][$i] =  $_REQUEST["departS$i"];
      $data['departT'][$i] =  $_REQUEST["departT$i"];
      $data['arrivalS'][$i] =  $_REQUEST["arrivalS$i"];
      $data['arrivalT'][$i] =  $_REQUEST["arrivalT$i"];
      $data['distance'][$i] =  $_REQUEST["distance$i"];
      $data['percent'][$i] =  $_REQUEST["percent$i"];
      $data['amount'][$i] =  $_REQUEST["amount$i"];
      $data['objective'][$i] =  $_REQUEST["objective0"];
    }
    if (claimTA($data, $reference, $empid, $year, $months, $cnt, $set))
      echo "<script>alert('User Claim added successfully');window.location='../Show_claimed_TA.php?ref=$reference';</script>";
    else
      echo "<script>alert('Something went wrong');window.location='../TA_Entry_Form.php';</script>";

    break;
  case 'addclaimTA':
    $cnt = $_REQUEST['hide_count'];
    $empid = $_REQUEST['empid'];
    $year = $_REQUEST['year'];
    $months = $_REQUEST['month'];
    $set = $_REQUEST['set'];
    $reference = $_REQUEST['reference'];
    $data = [];
    for ($i = 0; $i <= $cnt; $i++) {
      $data['date'][$i] =  $_REQUEST["date$i"];
      $data['train'][$i] =  $_REQUEST["train$i"];
      $data['departS'][$i] =  $_REQUEST["departS$i"];
      $data['departT'][$i] =  $_REQUEST["departT$i"];
      $data['arrivalS'][$i] =  $_REQUEST["arrivalS$i"];
      $data['arrivalT'][$i] =  $_REQUEST["arrivalT$i"];
      $data['distance'][$i] =  $_REQUEST["distance$i"];
      $data['percent'][$i] =  $_REQUEST["percent$i"];
      $data['amount'][$i] =  $_REQUEST["amount$i"];
      $data['objective'][$i] =  $_REQUEST["objective0"];
    }
    if (addclaimTA($data, $reference, $empid, $year, $months, $cnt, $set))
      echo "<script>alert('User Claim added successfully');window.location='../Show_claimed_TA.php?ref=$reference';</script>";
    else
      echo "<script>alert('Something went wrong');window.location='../TA_Entry_Form.php';</script>";

    break;

  case 'getTaAmount':
    $level = $_REQUEST['level'];
    echo getTaAmount($level);
    break;

  case 'approveAndForward':
    $empid = $_REQUEST['empid'];
    $ref = $_REQUEST['ref'];
    $forwardName = $_REQUEST['forwardName'];
    $original_id = $_REQUEST['original_id'];
    //echo $original_id;
    if (approveAndForward($empid, $ref, $forwardName, $original_id)) {
      echo "<script>alert('Travelling Allowance Claim forwarded');window.location='../Show_claimed_TA.php';</script>";
    } else {
      echo "<script>alert('Something went wrong');window.location='../Show_claimed_TA.php';</script>";
    }
    break;

  case 'AddEmployee':
    $empid = $_REQUEST['empid'];
    $pannumber = $_REQUEST['pannumber'];
    $empname = $_REQUEST['empname'];
    $billunit = $_REQUEST['billunit'];
    $mobile = $_REQUEST['mobile'];
    $email = $_REQUEST['email'];
    $design = $_REQUEST['design'];
    $paylevel = $_REQUEST['paylevel'];
    $button = $_REQUEST['button'];
    $update_id = $_REQUEST['update_id'];
    if ($button == "update") {
      if (updateEmployee($empid, $pannumber, $empname, $billunit, $mobile, $email, $design, $paylevel, $update_id))
        echo "<script>alert('Employee Updated successfully');window.location='../employee_registration.php';</script>";
      else
        echo "<script>alert('Something went wrong');window.location='../employee_registration.php';</script>";
    } else {
      if (AddEmployee($empid, $pannumber, $empname, $billunit, $mobile, $email, $design, $paylevel))
        echo "<script>alert('Employee Added successfully');window.location='../employee_registration.php';</script>";
      else
        echo "<script>alert('Something went wrong');window.location='../employee_registration.php';</script>";
    }
    break;
  case 'fetchEmployee':
    $id = $_REQUEST['id'];
    $result = fetchEmployee($id);
    echo $result;
    break;
  case 'AddDeptAdmin':
    $empid = $_REQUEST['empid'];
    $username = $_REQUEST['username'];
    $psw = $_REQUEST['psw'];
    $dept = $_REQUEST['dept'];
    if (AddAdmin($empid, $username, $psw, $dept))
      echo "<script>alert('Department Admin Added successfully');window.location='../add_user.php';</script>";
    else
      echo "<script>alert('Failed to add department admin');window.location='../add_user.php';</script>";
    break;

  case 'AddAcctAdmin':
    $empid = $_POST['empid'];
    $username = $_POST['username'];
    $psw = $_POST['psw'];
    $bu = implode(",", $_POST['bu']);
    // print_r($bu);
    // echo "<br>".sizeof($_POST['bu']);
    if (AddAcctAdmin($empid, $username, $psw, $bu))
      echo "<script>alert('Accountant Admin Added successfully');window.location='../add_account.php';</script>";
    else
      echo "<script>alert('Something Went wrong...');window.location='../add_account.php';</script>";
    break;


  case 'get_summary':
    echo $_POST['mon'];
    echo $query1 = "SELECT summary_id FROM master_summary WHERE MONTH(EST_approved_time) ='" . $_POST['mon'] . "' ";
    $result1 = mysqli_query($conn,$query1);

    break;

  case 'activeUser':
    $active = '1';
    $pfno = $_REQUEST['id'];
    if (activeUser($pfno, $active))
      echo "User Activated successfully";
    else
      echo "Something went wrong";
    break;
  case 'deactiveUser':
    $active = '0';
    $pfno = $_REQUEST['id'];
    if (deactiveUser($pfno, $active))
      echo "User Deactivated successfully";
    else
      echo "Something went wrong";
    break;

  case 'view_contingency':
    $data = '';
    $sql = "select * from continjency_master inner join continjency on continjency_master.id=continjency.cid where reference='" . $_REQUEST['ref'] . "' and continjency.set_number='" . $_REQUEST['set'] . "'";
    $raw_data = mysqli_query($conn,$sql);
    echo mysqli_error($conn);
    if ($raw_data) {
      $cnt = 0;
      while ($sql_res = mysqli_fetch_assoc($raw_data)) {
        $data .= "
                <tr>
                  <td>" . $sql_res['cntdate'] . "</td>
                  <td>" . $sql_res['cntfrom'] . "</td>
                  <td>" . $sql_res['cntTo'] . "</td>
                  <td>" . $sql_res['kms'] . "</td>
                  <td>" . $sql_res['rate_per_km'] . "</td>
                  <td>" . $sql_res['total_amount'] . "</td>
                </tr>
              ";
        $cnt += (int)$sql_res['total_amount'];
      }
      $data .= "
                <tr>
                  <td colspan='5' style='text-align:right;'>Total Amount</td>
                  <td>" . $cnt . "</td>
                </tr>
              ";
    } else {
      $data .= 0;
    }
    echo $data;
    break;

  case "applybillunit":
    $billunit = implode(",", $_POST['billunit']);
    if (applybillunit($_REQUEST['empid'], $billunit)) {
      echo "<script>alert('Bill Unit applied to User');window.location='../apply_billunit.php';</script>";
    } else {
      echo "<script>alert('Something Went Wrong');window.location='../apply_billunit.php';</script>";
    }
    break;

  case "deletebillunitemp":
    $query = mysqli_query($conn,"delete from sep_billunit where employee_id='" . $_REQUEST['deleteemp'] . "'");
    if ($query) {
      echo "<script>alert('User removed successfully');window.location='../apply_billunit.php';</script>";
    } else {
      echo "<script>alert('Something Went Wrong');window.location='../apply_billunit.php';</script>";
    }
    break;

  case "updatebillemp":
    $billunit = implode(",", $_REQUEST['updatebill']);
    $update_sql = "update sep_billunit set billunit='" . $billunit . "' where employee_id='" . $_REQUEST['updateemp'] . "'";
    $query = mysqli_query($conn,$update_sql);
    echo mysqli_error($conn);
    if ($query) {
      echo "<script>alert('User bill unit applied successfully');window.location='../apply_billunit.php';</script>";
    } else {
      echo "<script>alert('Something Went Wrong');window.location='../apply_billunit.php';</script>";
    }
    break;

  default:
    echo "Invalid option";
    break;
}
